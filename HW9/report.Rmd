---
title: "Tenth Week: Principal Component Analysis and Factor Analysis"
subtitle: "PCA Stock, image, ..."
author: "Aida Ramezani 95105595"
date: "`r Sys.time()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---
```{r echo = T, include=FALSE, message=F, error=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
library(ggplot2)
library(highcharter)
#readigdata-------
read.csv("../data/constituents.csv") -> names
com_symb <- as.data.frame(names$Symbol)

stocks = data.frame()
list.files("../data/stock_dfs") -> lists
indexes <- read.csv("../data/indexes.csv")
A <- read.csv("../data/stock_dfs/A.csv")

stocks = list()
A %>% mutate(industaryName = lists[1]) -> A
#stocks[[1]] = A

for (i in 2:length(lists)) {
  temp <- read_csv(paste("../data/stock_dfs", lists[i], sep = "/"))
  temp %>% mutate(industaryName = lists[i]) -> temp
  stocks[[i - 1]] = temp
  
}


bind_rows(stocks) -> industeries

```

***

<p dir="RTL">
۱.در این سوال سود را برابر با تفاضل اولین مقدار
Open
و آخرین مقدار آن در طی بازه گفته شده در نظر گرفتیم.
همچنین انتهای هر ماه را تا انتهای همان ماه در سال بعد (یا دوسال بعد یا پنج سال بعد) را بازه در نظر گرفتیم.
</p>
```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}

library(ggplot2)
constituents = read_csv("../data/constituents.csv")
#constituents %>% mutate(symbol2 = paste(Symbol, "csv", sep = ".")) -> constituents







A %>% mutate(Date = as.Date(Date)) -> A
colnames(A) = c("Date",
                "Open",
                "High",
                "Low",
                "Close",
                "Volume",
                "Adj Close",
                "industaryName")
A %>% mutate(
  year = format(Date, "%Y"),
  month = format(Date, "%m"),
  day = format(Date, "%d")
) -> A

industeries %>% mutate(
  year = format(Date, "%Y"),
  month = format(Date, "%m"),
  day = format(Date, "%d")
) -> industeries


rbind(A, industeries) -> industeries


industeries %>% mutate(industaryName = str_replace(industaryName, ".csv", "")) -> industeries

industeries %>% mutate(prof = Close - Open) -> industeries
full_join(constituents %>% select(Symbol, Sector),
          industeries,
          by = c("Symbol" = "industaryName")) -> sector_industary


sector_industary %>%
  mutate(time = as.numeric(year) * 12 + as.numeric(month)) %>%
  group_by(Symbol, time) %>%
  slice((which.max(Date))) %>%
  ungroup() %>%
  group_by(Symbol) %>% dplyr::mutate(rank = rank(-time , ties.method = "first")) %>%
  mutate(
    lagOpen = lag(Open, 12),
    lagSym = lag(Symbol, 12),
    lagTime = lag(time, 12)
  ) %>%
  filter(lagSym == Symbol) %>%
  mutate(prof = Open - lagOpen) %>%
  ungroup() %>%
  group_by(Symbol) %>%
  dplyr::summarise(prof = max(prof)) %>%
  arrange(desc(prof)) %>% head(10) %>%
  hchart(hcaes(x = Symbol , y = prof, color = Symbol), type = "bar") %>%  hc_title(text = "Companies Stock Over One Year") 

sector_industary %>%
  mutate(time = as.numeric(year) * 12 + as.numeric(month)) %>%
  group_by(Sector, time) %>%
  slice((which.max(Date))) %>%
  ungroup() %>%
  group_by(Sector) %>%
  mutate(
    lagOpen = lag(Open, 12),
    lagSector = lag(Sector, 12),
    lagTime = lag(time, 12)
  ) %>%
  filter(lagSector == Sector) %>%
  mutate(prof = Open - lagOpen) %>%
  ungroup() %>%
  group_by(Sector) %>%
  dplyr::summarise(prof = max(prof)) %>%
  arrange(desc(prof)) %>% head(10) %>%
  hchart(hcaes(x = Sector , y = prof, color = Sector), type = "bar")%>%  hc_title(text = "Sectors Stock Over One Year") 

#2sale-----------
sector_industary %>%
  mutate(time = as.numeric(year) * 12 + as.numeric(month)) %>%
  group_by(Symbol, time) %>%
  slice((which.max(Date))) %>%
  ungroup() %>%
  group_by(Symbol) %>% dplyr::mutate(rank = rank(-time , ties.method = "first")) %>%
  mutate(
    lagOpen = lag(Open, 24),
    lagSym = lag(Symbol, 24),
    lagTime = lag(time, 24)
  ) %>%
  filter(lagSym == Symbol) %>%
  mutate(prof = Open - lagOpen) %>%
  ungroup() %>%
  group_by(Symbol) %>%
  dplyr::summarise(prof = max(prof)) %>%
  arrange(desc(prof)) %>% head(10) %>%
  hchart(hcaes(x = Symbol , y = prof, color = Symbol), type = "bar")%>%  hc_title(text = "Companies Stock Over Two Years") 

sector_industary %>%
  mutate(time = as.numeric(year) * 12 + as.numeric(month)) %>%
  group_by(Sector, time) %>%
  slice((which.max(Date))) %>%
  ungroup() %>%
  group_by(Sector) %>%
  mutate(
    lagOpen = lag(Open, 24),
    lagSector = lag(Sector, 24),
    lagTime = lag(time, 24)
  ) %>%
  filter(lagSector == Sector) %>%
  mutate(prof = Open - lagOpen) %>%
  ungroup() %>%
  group_by(Sector) %>%
  dplyr::summarise(prof = max(prof)) %>%
  arrange(desc(prof)) %>% head(10) %>%
  hchart(hcaes(x = Sector , y = prof, color = Sector), type = "bar")%>%  hc_title(text = "Sectors Stock Over Two Years") 
#5sale-------------
sector_industary %>%
  mutate(time = as.numeric(year) * 12 + as.numeric(month)) %>%
  group_by(Symbol, time) %>%
  slice((which.max(Date))) %>%
  ungroup() %>%
  group_by(Symbol) %>% dplyr::mutate(rank = rank(-time , ties.method = "first")) %>%
  mutate(
    lagOpen = lag(Open, 60),
    lagSym = lag(Symbol, 60),
    lagTime = lag(time, 60)
  ) %>%
  filter(lagSym == Symbol) %>%
  mutate(prof = Open - lagOpen) %>%
  ungroup() %>%
  group_by(Symbol) %>%
  dplyr::summarise(prof = max(prof)) %>%
  arrange(desc(prof)) %>% head(10) %>%
  hchart(hcaes(x = Symbol , y = prof, color = Symbol), type = "bar")%>%  hc_title(text = "Companies Stock Over Five Years") 



sector_industary %>%
  mutate(time = as.numeric(year) * 12 + as.numeric(month)) %>%
  group_by(Sector, time) %>%
  slice((which.max(Date))) %>%
  ungroup() %>%
  group_by(Sector) %>%
  mutate(
    lagOpen = lag(Open, 60),
    lagSector = lag(Sector, 60),
    lagTime = lag(time, 60)
  ) %>%
  filter(lagSector == Sector) %>%
  mutate(prof = Open - lagOpen) %>%
  ungroup() %>%
  group_by(Sector) %>%
  dplyr::summarise(prof = max(prof)) %>%
  arrange(desc(prof)) %>% head(10) %>%
  hchart(hcaes(x = Sector , y = prof, color = Sector), type = "bar")%>%  hc_title(text = "Sectors Stock Over Two Years") 



```


***

<p dir="RTL">
۲. برای این سوال تفاضل 
Open
و 
lag(Open)
را برابر با سود در نظر گرفتیم و با استفاده از آزمون غیر پارامتریک
Wilcoxon
این جمله را بررسی کردیم.
مشاهده میشود که با توجه به
p-value
به دست آمده و فرض صفر برابر با عبارت صورت سوال، توانستیم به راحتی این فرض را رد کنیم.
</p>

```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}
industeries %>% mutate(nextOpen = lead(Open)) %>%   filter(day == 13) -> stock13
stock13 %>% mutate(prof = nextOpen - Open) -> stock13
round(100 * length(stock13$prof[which(stock13$prof < 0)]) / dim(stock13)[1], 2)
wilcox.test(stock13$prof, alternative = "greater") #alt mige 13 khoobe ya sefre, va farze sefr rad mishe

```
***

<p dir="RTL">
۳. گردش مالی را برابر با ضرب 
Volume
در
Adj Close
در نظر گرفتیم.
دلیل این اتفاق این است که در آن روز  
کالاهای اصلی صادرات و واردات از جمله نفت افت شدید قیمت داشته اند، در نتیجه سهام شرکت ها کاهش یافته و در پی آن مبادلات انجام شده برای خرید سهام افزایش یافته است. این روز به روز
stock market selloff
شهرت دارد. 
</p>
```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}
industeries %>% 
  group_by(Date) %>% 
  mutate(tradingVolum = sum(Volume * `Adj Close`, na.rm = T)) %>% 
  arrange(desc(tradingVolum)) %>% 
  head(1)
```
***

<p dir="RTL">
۴. 
k
ها را از 1 تا 20 در نظر گرفتیم و 
MSE
آن ها را با هم مقایسه کردیم.
مشاهده میشود که بهترین
k
12
میباشد.
</p>
```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}

library(h2o)
h2o.init()

industeries %>%
  filter(industaryName == "AAPL")  -> Apple



mean_square_error = c(1:20)
for (k in 2:20) {
  Apple$Open %>%
    matrix(ncol = k + 1, byrow = TRUE) %>%
    as.data.frame() -> temp
  happle = as.h2o(temp)
  hglm = h2o.glm(y = paste0("V", k + 1),
                 training_frame = happle)
  mean_square_error[k] = h2o.mse(hglm)
}


mean_square_error %>% as.data.frame() -> mean_square_error

colnames(mean_square_error) = c("er")



mean_square_error %>% mutate(k = row_number()) -> mean_square_error
mean_square_error %>%  hchart(hcaes(x = k , y = er, color = k), type = "column")

mean_square_error %>% filter(er != 1) %>%
  slice(which.min(er))
```
***

<p dir="RTL">
۵. 
</p>
```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}

industeries %>% select(Open, Close, Low, High, Volume, `Adj Close`, industaryName, Date) -> industeries_numeric
industeries_numeric %>% 
  drop_na() -> industeries_numeric

industeries_numeric %>% 
  select(industaryName, Date, Open) -> open_industary

open_industary %>% 
  spread(industaryName, Open) -> open_industary

open_industary %>% 
  select(-Date) %>% 
  drop_na() -> open_spread

open_spread %>% 
  prcomp(center = T) -> stock_pca



library("qcc")
stock_pca$sdev ^ 2 -> sdevs

qcc::pareto.chart(sdevs[1:20])

sdevs %>% as.data.frame() -> sdevs
colnames(sdevs) = c("s")

sdevs %>% mutate(s = s ^ 2) %>% 
  mutate(f = cumsum(s)/ sum(s)) %>% 
  .[1:3,] %>% 
  mutate(PC = (row_number())) %>% 
  hchart(hcaes(x = PC , y = f, color = PC) , type = "column")

```

***

<p dir="RTL">
۶.
با توجه به نمودار به دست آمده میتوان روز هایی از ماه که رفتار سهام مشابه بوده اند را گروه بندی کرد.
یعنی رفتار سهام برخی روز ها مشابه هم است. این روز ها در نمودار نسبت به سایر روز ها در کنار هم قرار گرقته اند.
</p>

```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}
sector_industary %>% drop_na %>%
  dplyr::group_by(Sector, Date) %>%
  dplyr::summarise(open = mean(Open)) -> sector_Date_Open
sector_Date_Open %>%
  spread(Sector, open) -> sector_Date_Open
indexes %>% mutate(Date = as.Date(Date)) -> indexes
full_join(indexes, sector_Date_Open) -> index_sector_open
rownames(index_sector_open) = index_sector_open$Date
index_sector_open %>% drop_na() %>% select(-Date) %>%
  prcomp(center = T) -> sector_pca

biplot(sector_pca, cex = 0.7)
```


***

<p dir="RTL">
۷. 
با مقایسه این سوال با سوال 4 مشاهده میشود که مدل دقیق تر شده است.
</p>
```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}
Apple %>% select(Open, Close, High, Low, Volume) -> Apple_numeric
apl.pca = prcomp(Apple_numeric, scale. = T)

apl.pca$x -> apple_pca

cbind(apple_pca, Apple_numeric) -> Apple_numeric


mean_square_error = c(1:20)
for (k in 2:20) {
  Apple_numeric$Open %>%
    matrix(ncol = k + 1, byrow = TRUE) %>% as.data.frame() -> temp
  Apple_numeric$PC1 %>%
    matrix(ncol = k + 1, byrow = TRUE) %>% as.data.frame() -> temp2
  colnames(temp) = c(paste("col", 1:k), "res")
  colnames(temp2) = c(paste("col", 1:k), "res")
  temp2$final = temp$final
  happle = as.h2o(temp2)
  hglm = h2o.glm(y = "res", training_frame = happle)
  mean_square_error[k] = h2o.mse(hglm)
}

mean_square_error = mean_square_error %>% as.data.frame()

mean_square_error %>% mutate(er = row_number()) -> mean_square_error

mean_square_error %>%
  hchart(hcaes(x = er, y = `.`), type = "column")

mean_square_error %>%
  filter(`.` != 1) %>%
  slice(which.min(`.`))


```

***

<p dir="RTL">
۸. 
در این سوال از مدل
h2o
استفاده کردیم.
همانطور که مشخص است دقت مدل حدود 70 درصد میباشد.
درصد خطای پیش بینی نیز در زیر نوشته شده است.
</p>

```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}
indexes %>% mutate(splag = lag(SP500)) %>%
  mutate(prof = (SP500 - splag) / splag) -> indexes
indexes %>%
  ggplot(aes(x = prof)) + geom_histogram(fill = "violet", stat = "density") + geom_density(stat = "density")


qqnorm(indexes$prof)
qqline(indexes$prof, col = 2)

open_industary[, 1:6] %>% drop_na() -> open_industary_2

open_industary_2 %>% 
  full_join(indexes %>%
   select(Date, SP500, prof), by = c("Date" = "Date")) %>%
  drop_na() -> sp500_open

sp500_open %>% mutate(isprof = ifelse(prof > 0 , 1, 0)) -> sp500_open

hsp_open = as.h2o(sp500_open)


hglm = h2o.glm(y = "isprof", x= colnames(sp500_open) %>% .[2:6],
                               training_frame = hsp_open, family="binomial",nfolds = 5)

hglm
```

***

<p dir="RTL"> 
تعداد مولفه ها برای فشرده سازی عکس را 35 در نظر گرفتیم.
مشاهده میشود که حجم عکس 0.8 شده است.
</p>
```{r echo = F, include=T, message=F, error=FALSE, warning=FALSE}
library("EBImage")
pic = flip(readImage("../data/stock.jpg")) #yek matrise se bodi
red.weigth   = imageData(pic)[,,1]
green.weigth = imageData(pic)[,,2]
blue.weigth  = imageData(pic)[,,3]
img = red.weigth * imageData(pic)[, , 1] +
  green.weigth * imageData(pic)[, , 2] + blue.weigth  * imageData(pic)[, , 3]

pca.img = prcomp(img, scale. = T)



plot(
  summary(pca.img)$importance[3, ],
  type = "l",
  ylab = "%variance explained",
  xlab = "nth component (decreasing order)"
)

abline(h = 0.9999, col = "red")
abline(v = 32, col = "red", lty = 3)


chosen.components = 1:35
feature.vector = pca.img$rotation[, chosen.components]
feature.vector[1:10, 1:5]

compact.data = t(feature.vector) %*% t(img) 



approx.img = t(feature.vector %*% compact.data)

image(approx.img, col = grey(seq(0, 1, length = 256)))

eigv = round(pca.img$sdev ^ 2 / sum(pca.img$sdev ^ 2) * 100, 2)
eigv = data.frame(c(1:412), eigv)
names(eigv) = c('PCs', 'Variance')
plot(eigv,
     type = "b",
     col = "violet",
     lwd = 2)
grid()
```

```{r echo = T, include=T, message=F, error=FALSE, warning=FALSE}
library(jpeg)
writeJPEG(approx.img, "p.jpg")
(file.info("p.jpg")$size / 1000) / (file.info("../data/stock.jpg")$size / 1000) * 100

```

***

<p dir="RTL"> 
میتوان شرکت های رقیب را پیدا کرد. دو شرکت رقیب محسوب میشوند اگر زمان رکود سهام یکی، برابر با زمان صعود سهام دیگری باشد.
</p>
</br>
<p dir="RTL"> 
پیدا کردن شرکت هایی که از سیاست اقتصادی یکسانی استفاده میکنند.
</p>
</br>
<p dir="RTL"> 
10
شرکت اولی که بیشترین گردش مالی سالیانه را در 5 سال اخیر دارند.
</p>
</br>
<p dir="RTL"> 
کدام شرکت ها در طی سال های داده شده در لبه پرتگاه ورشکستگی قرار داشتند.
</p>
</br>
<p dir="RTL"> 
نمایش تغییرات مبادلات انجام شده برای هر بخش در طی سال های داده شده، اوج شکوفایی هر بخش کدام سال است؟
</p>
